<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Navigation Game with Compass</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        overflow: hidden;
      }
      #game-ui {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 10px 20px;
        text-align: center;
        background-color: rgba(255, 255, 255, 0.9);
        z-index: 100;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #clue-message {
        font-size: 16px;
        font-weight: bold;
        color: #333;
        margin: 0;
        line-height: 1.4;
      }
      #status-message {
        font-size: 14px;
        color: #555;
        margin: 5px 0 0 0;
      }
      #start-button {
        background-color: #4caf50;
        color: white;
        padding: 12px 24px;
        font-size: 18px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        transition: background-color 0.3s;
      }
      #start-button:hover {
        background-color: #45a049;
      }
      #compass {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 150px;
        height: 150px;
        border: 5px solid #333;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #compass-pointer {
        position: absolute;
        width: 100px;
        height: 4px;
        background-color: red;
        transform-origin: bottom center;
        transform: rotate(0deg);
      }
      #compass-text {
        position: absolute;
        top: 60%;
        text-align: center;
        font-size: 16px;
        font-weight: bold;
        color: #333;
      }
      #destination-arrow {
        position: fixed;
        bottom: 200px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        border-bottom: 50px solid green;
      }
      #error-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        display: none;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div id="error-message"></div>
    <div id="game-ui">
      <p id="clue-message">Press Start to reveal the clue and begin navigation.</p>
      <p id="status-message">Press Start to begin navigation.</p>
      <button id="start-button" onclick="requestPermissionsAndStartGame()">Start Navigation</button>
    </div>
    <div id="destination-arrow"></div>
    <div id="compass">
      <div id="compass-pointer"></div>
      <div id="compass-text">Direction</div>
    </div>
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-assets timeout="5000">
        <a-asset-item id="target-model" src="AnimatedRalphie.glb"></a-asset-item>
      </a-assets>
      <a-entity
        id="target-model-entity"
        gps-entity-place
        scale="1.5 1.5 1.5"
        visible="false"
        gltf-model="#target-model">
      </a-entity>
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>
    <script>
      // Game configuration
      const DESTINATION_THRESHOLD = 20; // meters
      const VISIBILITY_THRESHOLD = 50; // meters to make model visible

      // Predefined locations
      const locations = [
        { 
          latitude: 40.007154, 
          longitude: -105.270400, 
          clue: "The heart of CU, where students flock to study and socialize. You'll find Ralphie near the fountain." 
        },
        { 
          latitude: 40.006191, 
          longitude: -105.271594, 
          clue: "Where books and knowledge abound, Ralphie's hiding somewhere profound." 
        },
        { 
          latitude: 40.008563, 
          longitude: -105.270201, 
          clue: "Catch a game or feel the roar of the crowd. Ralphie loves to run here!" 
        },
        { 
          latitude: 40.009452, 
          longitude: -105.269720, 
          clue: "Beneath the red roof of this arts haven, find Ralphie enjoying a masterpiece." 
        }
      ];

      // Game state variables
      let targetLocation;
      let gameStarted = false;
      let watchId = null;
      let currentHeading = 0;
      let currentLocation = null;

      // Error handling function
      function showError(message) {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        console.error(message);
      }

      // Hide error message
      function hideError() {
        const errorElement = document.getElementById('error-message');
        errorElement.style.display = 'none';
      }

      // Request permissions and start game
      function requestPermissionsAndStartGame() {
        if (!navigator.geolocation) {
          showError('Geolocation is not supported by this browser.');
          return;
        }

        // Request location permission first
        navigator.geolocation.getCurrentPosition(
          () => {
            // Try to request device orientation permission (for iOS)
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
              DeviceOrientationEvent.requestPermission()
                .then(response => {
                  if (response === 'granted') {
                    startGame();
                  } else {
                    showError('Device orientation permission denied');
                  }
                })
                .catch(error => showError(`Permission error: ${error}`));
            } else {
              // For browsers that don't require explicit permission
              startGame();
            }
          }, 
          (error) => {
            showError(`Location permission error: ${error.message}`);
          }
        );
      }

      // Start the game
      function startGame() {
        if (gameStarted) return;

        gameStarted = true;
        hideError();
        document.getElementById("start-button").style.display = "none";

        // Randomly select a location
        targetLocation = locations[Math.floor(Math.random() * locations.length)];
        
        document.getElementById("clue-message").textContent = `Clue: ${targetLocation.clue}`;
        document.getElementById("status-message").textContent = "Tracking your location...";

        // Verify model is loaded
        const modelEntity = document.getElementById("target-model-entity");
        const modelAsset = document.getElementById("target-model");

        if (!modelAsset) {
          showError("Model asset not found. Please check the file path.");
          return;
        }

        // Set location for the model
        modelEntity.setAttribute("gps-entity-place", `latitude: ${targetLocation.latitude}; longitude: ${targetLocation.longitude}`);
        
        // Start location tracking
        watchId = navigator.geolocation.watchPosition(
          onLocationUpdate, 
          onLocationError, 
          {
            enableHighAccuracy: true,
            timeout: 20000,
            maximumAge: 0
          }
        );

        // Initialize device orientation
        initDeviceOrientation();

        // Add model load event listeners for debugging
        modelEntity.addEventListener('model-loaded', () => {
          console.log('Model loaded successfully');
        });

        modelEntity.addEventListener('model-error', (event) => {
          showError(`Model loading error: ${event.detail}`);
        });
      }

      // Rest of the code remains the same as in the previous implementation...
      // [All previous functions like onLocationUpdate, calculateDistance, etc. remain unchanged]

      // Enhanced error handling for location tracking
      function onLocationError(error) {
        console.error('Location tracking error:', error);
        
        let errorMessage = "An unknown error occurred while tracking location.";
        
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = "Location permission denied. Please enable location services.";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = "Location information is unavailable.";
            break;
          case error.TIMEOUT:
            errorMessage = "Location request timed out.";
            break;
        }
        
        showError(errorMessage);
        document.getElementById("status-message").textContent = errorMessage;
      }
    </script>
  </body>
</html>
