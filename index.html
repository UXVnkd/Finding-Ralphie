<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Ralphie Navigation Game</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      body { 
        margin: 0; 
        font-family: Arial, sans-serif; 
        overflow: hidden; 
      }
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: rgba(255,255,255,0.9);
        padding: 10px;
        text-align: center;
        z-index: 1000;
      }
      #debug-info {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px;
        max-width: 300px;
        z-index: 1000;
        font-size: 12px;
        overflow: auto;
        max-height: 200px;
      }
      #start-button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="overlay">
      <h3 id="clue-message">Find Ralphie at the CU Boulder Campus!</h3>
      <p id="status-message">Press Start to begin the AR adventure</p>
      <button id="start-button" onclick="startARGame()">Start Navigation</button>
    </div>
    
    <div id="debug-info"></div>

    <a-scene 
      embedded 
      arjs="sourceType: webcam; 
             debugUIEnabled: false; 
             detectionMode: mono_and_matrix; 
             matrixCodeType: 3x3;"
      vr-mode-ui="enabled: false"
    >
      <a-assets>
        <a-asset-item id="ralphie-model" src="AnimatedRalphie.glb"></a-asset-item>
      </a-assets>

      <a-entity 
        id="ralphie-entity"
        gps-entity-place
        gltf-model="#ralphie-model"
        animation-mixer
        scale="3 3 3"
        position="0 0 0"
        visible="false"
      ></a-entity>

      <a-camera gps-camera rotation-reader look-controls></a-camera>
    </a-scene>

    <script src="https://unpkg.com/aframe-animation-mixer-component@2.1.1/dist/aframe-animation-mixer-component.min.js"></script>

    <script>
      // Logging function
      function debugLog(message) {
        const debugInfo = document.getElementById('debug-info');
        const logEntry = document.createElement('p');
        logEntry.textContent = message;
        debugInfo.appendChild(logEntry);
        debugInfo.scrollTop = debugInfo.scrollHeight;
        console.log(message);
      }

      // Predefined locations around CU Boulder campus
      const LOCATIONS = [
        {
          name: "Norlin Library",
          latitude: 40.007154,
          longitude: -105.270400,
          clue: "Near the heart of knowledge, find Ralphie by the historic library!"
        },
        {
          name: "Folsom Field",
          latitude: 40.008563,
          longitude: -105.270201,
          clue: "Where buffaloes roam and football dreams are born!"
        },
        {
          name: "University of Colorado Museum",
          latitude: 40.009452,
          longitude: -105.269720,
          clue: "Discover Ralphie amid the treasures of history!"
        }
      ];

      // Game state
      let currentLocation = null;
      let targetLocation = null;
      let watchId = null;

      // Start AR Game
      function startARGame() {
        // Hide start button
        document.getElementById('start-button').style.display = 'none';

        // Select random location
        targetLocation = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
        
        // Update UI
        document.getElementById('clue-message').textContent = targetLocation.clue;
        document.getElementById('status-message').textContent = `Find Ralphie at: ${targetLocation.name}`;

        // Request location permissions
        if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(
            updateLocation, 
            handleLocationError, 
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 30000
            }
          );
        } else {
          debugLog('Geolocation is not supported by this browser.');
        }
      }

      // Update location and model visibility
      function updateLocation(position) {
        const { latitude, longitude } = position.coords;
        
        // Calculate distance to target
        const distance = calculateDistance(
          latitude, longitude, 
          targetLocation.latitude, 
          targetLocation.longitude
        );

        // Debug logging
        debugLog(`Current Location: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`);
        debugLog(`Target Location: ${targetLocation.latitude.toFixed(6)}, ${targetLocation.longitude.toFixed(6)}`);
        debugLog(`Distance to Target: ${distance.toFixed(2)} meters`);

        // Get Ralphie entity
        const ralphieEntity = document.getElementById('ralphie-entity');

        // Set GPS coordinates for Ralphie
        ralphieEntity.setAttribute('gps-entity-place', 
          `latitude: ${targetLocation.latitude}; longitude: ${targetLocation.longitude}`
        );

        // Adjust visibility and scale based on distance
        if (distance <= 50) {
          ralphieEntity.setAttribute('visible', 'true');
          ralphieEntity.setAttribute('scale', '5 5 5');
          debugLog('Ralphie is now visible!');
        } else {
          ralphieEntity.setAttribute('visible', 'false');
          debugLog('Ralphie is hidden. Get closer!');
        }
      }

      // Calculate distance between two coordinates (Haversine formula)
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // Earth's radius in meters
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a = 
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) * Math.cos((lat2 * Math.PI) / 180) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Handle location tracking errors
      function handleLocationError(error) {
        switch(error.code) {
          case error.PERMISSION_DENIED:
            debugLog("Location permission denied.");
            break;
          case error.POSITION_UNAVAILABLE:
            debugLog("Location information unavailable.");
            break;
          case error.TIMEOUT:
            debugLog("Location request timed out.");
            break;
          default:
            debugLog("Unknown location error.");
        }
      }
    </script>
  </body>
</html>
