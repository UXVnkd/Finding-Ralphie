<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Ralphie in AR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body>
    <!-- AR.js Scene -->
    <a-scene embedded arjs="sourceType: webcam;">
        <a-marker preset="hiro">
            <a-entity gltf-model="url(ralphie-model.glb)" scale="0.5 0.5 0.5"></a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>

    <!-- Geolocation Script -->
    <script>
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(showPosition, showError);
        } else {
            alert("Geolocation is not supported by this browser.");
        }

        function showPosition(position) {
            const playerLat = position.coords.latitude;
            const playerLng = position.coords.longitude;

            // Hardcoded location of Ralphie (replace with actual coordinates)
            const ralphieLat = 40.0076;  // Example latitude of a spot on CU Boulder campus
            const ralphieLng = -105.2659; // Example longitude

            // Calculate the distance between player and Ralphie
            const distance = calculateDistance(playerLat, playerLng, ralphieLat, ralphieLng);
            if (distance < 50) {
                document.querySelector('a-marker').setAttribute('visible', true);  // Show Ralphie when nearby
                alert("You're close to finding Ralphie!");
            } else {
                document.querySelector('a-marker').setAttribute('visible', false); // Hide Ralphie when far away
            }
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }

        // Helper function to calculate distance using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }
    </script>
</body>
</html>
