// Function to set target position within 10 meters
function setRandomTargetPosition(latitude, longitude) {
    // Random angle in radians (0 to 2π)
    const randomAngle = Math.random() * 2 * Math.PI;
    
    // Random distance between 5 and 10 meters (to make it more interesting)
    const distance = 5 + (Math.random() * 5);
    
    // Convert distance to angular distance on Earth's surface
    const earthRadius = 6371000; // Earth's radius in meters
    const angularDistance = distance / earthRadius;

    // Convert latitude and longitude to radians
    const lat1 = latitude * (Math.PI / 180);
    const lon1 = longitude * (Math.PI / 180);

    // Calculate new latitude
    const lat2 = Math.asin(
        Math.sin(lat1) * Math.cos(angularDistance) +
        Math.cos(lat1) * Math.sin(angularDistance) * Math.cos(randomAngle)
    );

    // Calculate new longitude
    const lon2 = lon1 + Math.atan2(
        Math.sin(randomAngle) * Math.sin(angularDistance) * Math.cos(lat1),
        Math.cos(angularDistance) - Math.sin(lat1) * Math.sin(lat2)
    );

    // Convert back to degrees
    return {
        latitude: lat2 * (180 / Math.PI),
        longitude: lon2 * (180 / Math.PI),
        distance: distance,  // Store actual distance for verification
        angle: randomAngle * (180 / Math.PI)  // Store angle in degrees for debugging
    };
}

// Modified startGame function
function startGame() {
    if (!gameStarted) {
        gameStarted = true;
        document.getElementById('start-button').style.display = 'none';
        document.getElementById('status-message').textContent = "Setting up target location...";

        if (navigator.geolocation) {
            // Get initial position with high accuracy
            navigator.geolocation.getCurrentPosition(
                position => {
                    // Set target position
                    targetPosition = setRandomTargetPosition(
                        position.coords.latitude,
                        position.coords.longitude
                    );

                    // Update target model's position
                    const targetModel = document.getElementById('target-model-entity');
                    targetModel.setAttribute('gps-entity-place', {
                        latitude: targetPosition.latitude,
                        longitude: targetPosition.longitude
                    });

                    // Log target placement for debugging
                    console.log('Target placed:', {
                        distance: targetPosition.distance.toFixed(2) + 'm',
                        angle: targetPosition.angle.toFixed(2) + '°',
                        coordinates: {
                            lat: targetPosition.latitude,
                            lng: targetPosition.longitude
                        }
                    });

                    // Create navigation arrows
                    createArrows();

                    // Start continuous position tracking
                    navigator.geolocation.watchPosition(
                        updateGameState,
                        showError,
                        {
                            enableHighAccuracy: true,
                            maximumAge: 1000,
                            timeout: 20000
                        }
                    );

                    document.getElementById('status-message').textContent = 
                        `Target placed ${Math.round(targetPosition.distance)}m away at ${Math.round(targetPosition.angle)}°! Follow the arrows to find it.`;
                },
                showError,
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }
}

// Modified updateGameState function to verify distance
function updateGameState(position) {
    if (!targetPosition || !gameStarted) return;

    const currentDistance = calculateDistance(
        position.coords.latitude,
        position.coords.longitude,
        targetPosition.latitude,
        targetPosition.longitude
    );
    
    const bearing = calculateBearing(
        position.coords.latitude,
        position.coords.longitude,
        targetPosition.latitude,
        targetPosition.longitude
    );

    // Update UI with more precise information
    document.getElementById('status-message').textContent = 
        `Distance: ${currentDistance.toFixed(1)}m | Direction: ${Math.round(bearing)}° | ` +
        `Initial Distance: ${targetPosition.distance.toFixed(1)}m`;

    // Update navigation arrows
    updateArrows(bearing, currentDistance);

    // Check if player has reached the target (within 2 meters)
    if (currentDistance < 2 && !congratsShown) {
        document.getElementById('acknowledgment').style.display = 'block';
        document.getElementById('acknowledgment').textContent = 
            `Congratulations! You've found the target! \n` +
            `Final distance: ${currentDistance.toFixed(1)}m`;
        congratsShown = true;
        arrows.forEach(arrow => arrow.setAttribute('visible', 'false'));
    }
}
